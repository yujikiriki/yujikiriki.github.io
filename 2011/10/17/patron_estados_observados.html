<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bliki | Patrón de estados observados</title>
    <link rel="stylesheet" href="/css/foundation.css" />
    <script src="/js/vendor/modernizr.js"></script>
  </head>
  <body>
<!-- Page begins  -->
  <div class="row bottom-border">
    <div class="large-11 columns">
      <h1><small><a href="https://yujikiriki.github.io/index.html">_bliki</a></small></h1>
    </div>
  </div>
  <div class="row">
    <div class="large-8 columns">
      <div class="row">
        <div class="large-12 columns">
          <br/>
          <h2>PATRóN DE ESTADOS OBSERVADOS</h2>
          <h6 class="subheader">Por: <a href="http://yujikiriki.com/me.html">Yuji Kiriki</a></h6>
          <h6 class="subheader">Publicado: October 17, 2011</h6>
          <h6 class="subheader">Número de palabras: 2666</h6>
          <h6 class="subheader">Categorías: </h6>
        </div>
      </div>
      <br/><br/>
      <p>Durante los últimos años he participado en el diseño de aplicaciones que involucran procesos de negocio donde la estrella principal es una entidad en particular: una solicitud de préstamo, una solicitud de compra de un bien o un servicio, una queja o un reclamo, entre muchos otros.</p>

<p>No les ha pasado que cuando se enfrentan a este tipo proyectos ¿el comportamiento de negocio de la entidad estrella del proceso queda llena de invocaciones a envíos de correos electrónicos y llamados a sistemas externos que <strong>nada</strong> tienen que ver con las reglas de negocio que se requieren evaluar?</p>

<p>Es típico. Esa clase que hace de todo porque es la entidad central del proceso de negocio. Esa clase que nos hace pasar horas hurgándola y depurándola porque hace demasiado. Esa clase que llega a ser intocable y no permite que la aplicación evolucione.</p>

<p>Uno puede pensar que para evitar esto puede hacer delegados, fachadas, decoradores y demás, pero por más que ustedes aplican patrones y patrones, el código de la entidad estrella sigue plagada de código que <strong>no</strong> tiene que ver con el comportamiento del negocio sino que tiene más que ver con las consecuencias de las reglas de negocio.</p>

<p>En esta entrada presento un patrón que se me ocurrió para este tipo de proyectos evitando que el panorama se torne tan negro, permitiendoles asignar responsabilidades de manera rápida y segura, además de que les puede dar gratis procesamiento distribuido y gobierno de transacciones en sus aplicaciones empresariales.</p>

<p>Para facilitar la comprensión de esta esta entrada, publiqué un proyecto de ejemplo de este patrón y lo pueden encontrar <a href="https://github.com/yujikiriki/ObservedStatePattern">acá</a>.</p>

<h3 id="patrn-de-estados-observados">Patrón de estados observados</h3>

<p>Este es el resultado de la combinación de dos patrones de GoF: <strong>Observador</strong> y <strong>Estado</strong>. Le pusimos un nombre a modo de etiquetar la estrategia para resolver un tipo de problema recurrente en la construcción de aplicaciones empresariales que involucran procesos y tienen entidades estrella.</p>

<h4 id="patrn-observador">Patrón observador</h4>

<p>El siguiente es el diagrama de entidades que describe al patrón observador un poco matizado:</p>

<p><img style="margin-left: auto; margin-right: auto;" src="../../../imgs/PatronObservador.png" width="550px" height="91px" /></p>

<p>Es el típico patrón observador de GoF, solo que se hace énfasis en la estandarización del objeto de intercambio de mensajes que existe entre las entidades que observan y el sujeto observado. Además de estandarizar la comunicación entre el sujeto y los observadores, el mensaje nos permite agregarle versatilidad al patrón, como lo veremos más adelante.</p>

<p>Como muchos sabrán, el patrón observador también es conocido como el patrón de <em>Publicación-Suscripción</em> y nos será útil precisamente por eso, porque nos permitirá tener múltiples suscriptores a eventos generados por una sola entidad que publica eventos.</p>

<p>El patrón observador permite abstraer el concepto de dependencia que existe entre una entidad con otra. Lo más dulce del asunto es que la entidad que publica no es consciente de la funcionalidad de sus suscriptores u observadores, logrando así un alto nivel de desacoplamiento entre el comportamiento del sujeto y los suscriptores.</p>

<h4 id="patrn-estado">Patrón Estado</h4>

<p>El siguiente es el diagrama del patrón Estado que utilizaremos para el de Estados Observados:</p>

<p><img style="margin-left: auto; margin-right: auto;" src="../../../imgs/PatronEstado.png" width="430px" height="68px" /></p>

<p>La gráfica describe una clase abstracta <strong>EntidadConEstados</strong> la cual modela las entidades que por definición del dominio tienen estados. Por ejemplo, una queja de un sistema de atención de quejas puede tener que pasar a un estado prioritario al pasar de cierto número de días. Cada uno de estos estados de la entidad será representado por clases que cumplan el contrato definido por la interface <strong>IEstadoEntidad</strong>.</p>

<p>Además de permitirnos modelar de una manera bastante directa una entidad con múltiples estados, el patrón nos permite modelar y encapsular el comportamiento especifico en cada uno de los estados posibles de la <strong>EntidadConEstados</strong> más el de cada una de las transiciones dadas entre estado y estado.</p>

<p>De esta manera, cada estado implementa un algoritmo distinto permitiéndole a la <strong>EntidadConEstados</strong> delegar la responsabilidad funcional de qué hacer en cada estado al objeto que modela el estado (es decir a las clases que cumplen con el contrato definido por <strong>IEstadoEntidad</strong>).</p>

<h4 id="la-unin-hace-la-fuerza">La unión hace la fuerza</h4>

<p>Hasta acá nada nuevo, nada especial. Solo un pequeño repaso de dos patrones de comportamiento de GoF que al combinarlos podríamos obtener un resultado interesante:</p>

<p><img style="margin-left: auto; margin-right: auto;" src="../../../imgs/EstadosObservados01.png" width="330px" height="332px" /></p>

<p>En el diagrama anterior vemos las mismas clases que veíamos en las gráficas anteriores solo que juntas. En la sección derecha está el patrón Observador y en la de la izquierda vemos el patrón Estados. Lo único que en este momento une a los patrones es que <strong>EntidadConEstados</strong> será una entidad observable.</p>

<p>Como se mencionó anteriormente, lo interesante por observar de una <strong>EntidadConEstados</strong> es precisamente sus estados y sus transiciones pues cada una representa un comportamiento fundamental del dominio.</p>

<p>Esta es una buena pista ya que las clases <strong>IEstadoEntidad</strong> contendrán el algoritmo requerido por el estado que representan y las consecuencias funcionales de que la <strong>EntidadConEstados</strong> haya pasado a ese estado podrán implementarse en las entidades suscritas u observadoras de la <strong>EntidadConEstados</strong>.</p>

<p>Si se detienen a pensar un poco el párrafo anterior, se darán cuenta que estas implicaciones y consecuencias no deben ser implementadas dentro del contexto semántico de la <strong>EntidadConEstados</strong>. A continuación explicamos porqué.</p>

<p>Un cambio de estado de una <strong>EntidadConEstados</strong> es un evento destacable del dominio del negocio. Al ser destacable ese cambio de estado tiene asociados múltiples requerimientos funcionales como enviar un correo electrónico a alguien, crear un registro en una bitácora, registrar el cambio de estado en un reporte, realizar un consumo de un servicio de sistema externo entre muchos otros. Estos requerimientos funcionales no hacen parte del dominio de la <strong>EntidadConEstados</strong> como tal, pues queda un poco incomodo dejar este tipo de algoritmos inmersos en las reglas de negocio implementadas en ella o en un <strong>IEstadoEntidad</strong>.</p>

<p>Lo que sí es muy cómodo es crear observadores de estos eventos y en ellos delegar la responsabilidad de realizar esas funciones que no tienen que ver con el comportamiento del negocio, lo cual sí es responsabilidad de la <strong>EntidadConEstados</strong>. Así, podríamos implementar el envío del correo electrónico en un observador especializado y que realice la notificación solo cuando a él le toque o le interese, evitando mezclar peras (comportamiento de negocio) con manzanas (requerimientos funcionales que no pertenecen al dominio de negocio).</p>

<p>Es necesario anotar que un observador debe estar suscrito a todos los cambios de estado, pero no necesariamente le deben interesar todos.</p>

<p>El siguiente diagrama presenta el diagrama del patrón Estados Observados un poco más completo para que soporte más funcionalidades:</p>

<p><img style="margin-left: auto; margin-right: auto;" src="../../../imgs/EstadosObservados02.png" width="450px" height="596px" /></p>

<p>En el diagrama anterior podemos identificar dos clases nuevas: <strong>EventoDeDominio</strong> y <strong>SuscriptorDeCambiosDeEstado</strong>. La primera implementa el contrato <strong>Mensaje</strong>, lo que implica que esta será el móvil que permitirá la comunicación entre la <strong>EntidadConEstados</strong> y sus observadores.</p>

<h4 id="un-evento-del-dominio">Un evento del dominio</h4>

<p>Una instancia de la clase <strong>EventoDeDominio</strong> contiene información útil para cualquier aplicación como la hora de su ocurrencia, su hora de notificación, origen, etc. La clase captura algo ocurrido (en tiempo pasado) en la <strong>EntidadConEstados</strong> y deberá contener todo lo que requieran los suscriptores.</p>

<p><img style="margin-left: auto; margin-right: auto;" src="../../../imgs/EventoDeDominio.png" width="216px" height="123px" /></p>

<p>Para que nuestro patrón funcione es necesario poder identificar fácilmente de qué evento se trata y así determinar si el evento le interesa o no comparándolo contra una lista de eventos identificados como interesantes para ellos. Para esto modelamos el atributo “<em>tipo</em>” que pertenece a un conjunto finito de elementos.</p>

<p>También es necesario tener todos los datos de negocio relevantes del evento para que los posibles suscriptores sean lo más autónomos posible y sus algoritmos puedan trabajar solo con los datos recibidos. Para transportar esta información dejamos un atributo “<em>data</em>”.</p>

<h4 id="un-suscriptor-de-cambios-de-estado">Un suscriptor de cambios de estado</h4>

<p>Como su nombre lo indica, la clase <strong>SuscriptorDeCambiosDeEstado</strong> está suscrita a todos los cambios de estado que la <strong>EntidadConEstados</strong> sufra debido a las reglas de negocio que la gobiernan y la manipulación que los usuarios finales de la aplicación realicen sobre ella a través de servicios o la capa de presentación.</p>

<p>Un <strong>SuscriptorDeCambiosDeEstado</strong> solo está interesado en algunos cambios de estado y para ello cuenta con una lista de eventos interesantes para él. Cada vez que le llegue un <strong>EventoDeDominio</strong> interesante el tendrá el algoritmo adecuado que trabaje sobre los datos recibidos del evento.</p>

<p>Si mapeamos este patrón a una aplicación distribuida, podemos hacer que un <strong>SuscriptorDeCambiosDeEstado</strong> no comparta necesariamente el mismo espacio de memoria que la <strong>EntidadConEstados</strong> pues el <strong>Mensaje</strong> puede propagarse a través de algún protocolo (HTTP por ejemplo) o a través de una cola a otro espacio de memoria de otra máquina, permitiéndonos tener procesamiento distribuido de mensajes gratis.</p>

<h3 id="ejemplo">Ejemplo</h3>

<p>Una vez se ha entendido el mecanismo básico de comunicación entre las clases podemos entrar a ver el patrón en acción a través de un ejemplo.</p>

<p>Nuestro ejemplo está inspirado en la implementación de una aplicación BPM que hoy en día se encuentra en producción, en la cual se utilizó el patrón de Estados Observados con bastante éxito.</p>

<p>Vamos a tomar como ejemplo el proceso de quejas de una empresa de telefonía móvil en una versión muy simplificada:</p>

<p><img style="margin-left: auto; margin-right: auto;" src="../../../imgs/QuejaProceso.png" width="367px" height="577px" /></p>

<h4 id="descripcin-del-proceso">Descripción del proceso</h4>

<ul>
  <li>El proceso lo inicia el envío de un formulario de queja diligenciado a través del portal Web de la compañía.</li>
  <li>La queja es clasificada para que se le dé una correcta gestión según el tipo queja. Una queja puede ser clasificada de 1 a 3.</li>
  <li>Según la clasificación de la queja, esta es asignada a un empleado de la empresa para que le dé una rápida gestión.</li>
  <li>Una vez se finaliza la gestión de la queja, el usuario es notificado de la respuesta de la compañía.</li>
</ul>

<p>Como es usual, hay unos detalles que mariposean alrededor del proceso de negocio:</p>

<ul>
  <li>Si la queja es clasificada de nivel <em>3</em> el sistema deberá notificar a la <strong>Unidad de Mercadeo</strong> para que este envíe un regalo al usuario.</li>
  <li>Si han pasado más de <strong>5 días</strong> después de que el usuario registró la queja y esta no ha sido resuelta, la queja debe aumentar al máximo nivel de prioridad.</li>
  <li>Una queja puede tener prioridad <strong>Alpha</strong> u <strong>Omega</strong>. Si es <strong>Alpha</strong>, tiene la máxima prioridad y esta deberá ir en el <strong>reporte semanal de quejas</strong> de la compañía. Una queja adquiere prioridad <strong>Alpha</strong> si han pasado más de <strong>5</strong> días de haberse recibido.</li>
  <li>Se espera poder tener información en tiempo cercano al real del estado de cualquier queja y cómo ha sido su gestión para posibles auditorías por parte de la Superintendencia de Servicios Públicos.</li>
</ul>

<p>METER EJEMPLO DE CONSUMO DE UN SERVICIO ASINCRONO</p>

<h4 id="la-propuesta-de-solucin-usando-el-patrn">La propuesta de solución usando el patrón</h4>

<p><img style="float:left" src="../../../imgs/marrano.png" width="150px" height="125px" /></p>

<p>Bien podría uno acribillar el BPEL de <em>&lt;choices&gt;</em> e <em>&lt;invoke&gt;</em> y modelar absolutamente todo en el proceso sin separar responsabilidades ni detenerse a modelar el dominio con actitud de <em>“Ahhhhhrrrrrggghhhh eso de todas maneras no lo voy a mantener yo, marranos…“</em>; o bien podría usar el <strong>patrón de estados observados</strong>.</p>

<p>A continuación se presenta el diagrama que contiene el modelo de la entidad de negocio Queja como una <strong>EntidadConEstados</strong> y sus <strong>SuscriptorDeCambiosDeEstado</strong>:</p>

<p><img style="margin-left: auto; margin-right: auto;" src="../../../imgs/ejemplo.png" width="550px" height="342px" /></p>

<p>En la gráfica se presentan tres <strong>SuscriptorDeCambiosDeEstado</strong> para la <strong>EntidadConEstados</strong> <em>Queja</em>, a saber: <em>Notificación</em>, <em>ReporteAuditoría</em> y <em>QuejaPrioridadAlpha</em>.</p>

<p>Como se explicó, los <strong>SuscriptorDeCambiosDeEstado</strong> están atentos a todos los <strong>EventoDeDominio</strong> que emite la <strong>EntidadConEstados</strong>. Al suscriptor <em>Notificación</em> solo le interesan aquellos que impliquen el envío de correos electrónicos, tal como el requerimiento de enviar notificación a la <strong>Unidad de Mercadeo</strong> para que le envíe un regalo al usuario cuando la queja adquiere clasificación 3.</p>

<p>Cuando <em>Queja</em> cambie a prioridad <strong>Alpha</strong> debido a que se cumple la regla de negocio, el suscriptor <em>QuejaPrioridadAlpha</em> tendrá la responsabilidad de ingresar la información de la <em>Queja</em> al reporte semanal de quejas.</p>

<p>El suscriptor <em>ReporteAuditoría</em> estará escuchando todos los cambios de la entidad <em>Queja</em>: el usuario que hizo el cambio, la hora en la que la hizo, la IP desde dónde realizó la modificación sobre la queja y qué modificación realizó. Si uno realiza una consulta por el ID de la queja sobre este reporte tendrá toda la información transaccional de la queja, información que como imaginarán es muy poderosa al tratar de capturar un error de la aplicación o la resolución particular de una queja.</p>

<p>Los anteriores son solo tres ejemplos de simplificación del desarrollo de este tipo de requerimientos gracias al patrón utilizado. La simplificación se evidencia principalmente por presentar una solución más fácil de mantener y de evolucionar.</p>

<p>Cualquier requerimiento nuevo consecuencia de una evaluación de reglas de negocio puede ser implementado rápidamente en un nuevo <strong>SuscriptorDeCambiosDeEstado</strong>. O por ejemplo, si se necesita agregar una nueva notificación por correo electrónico, lo único que se debe hacer es meter un nuevo evento interesante en la lista de eventos interesantes de <em>Notificación</em>.</p>

<p>Ahora, pueden también imaginarse que cada uno de estos <strong>SuscriptorDeCambiosDeEstado</strong> se encuentra desplegado en distintos servidores en varias particiones de red. La Queja cuando emite un evento ya no lo hace a través de memoria compartida sino que publica el evento como un mensaje a una cola JMS. Cada uno de los <strong>SuscriptorDeCambiosDeEstado</strong> es un MDB que está suscrito a esa cola. Al hacer ese sencillo cambio, ya distribuyeron su aplicación y aumentaron la disponibilidad de su aplicación pues la transacción que gobierna el cambio de estado de la Queja ya no gobierna las transacciones consecuentes de este cambio.</p>

<p>Un <strong>SuscriptorDeCambiosDeEstado</strong> puede también tener la lógica requerida para afectar un sistema externo como un CRM, un ERP o un sistema de gestión documental. De esta manera realiza integración de sus aplicaciones desde la definición misma de la entidad estrella, logrando crear el vínculo entre el dominio del negocio y sus necesidades de integración.</p>

<h3 id="conclusiones">Conclusiones</h3>

<p>Una vez se tienen claros los requerimientos funcionales, el mayor reto al construir una aplicación empresarial crítica es lograr modelar el comportamiento del dominio del negocio en algoritmos y estructuras. El patrón que les acabo de explicar logra vincular de manera bastante práctica el comportamiento del dominio y las consecuencias esperadas de este comportamiento.</p>

<p>Este patrón permite separar de manera clara las reglas de negocio los requerimientos funcionales que no hacen parte del comportamiento del negocio. De hecho, al utilizarlo, se refuerza la noción de desacoplamiento dentro comportamiento de negocio mismo, permitiendo que su mantenimiento o su evolución se pueda realizar pensando en dos vistas independientes: comportamiento y consecuencia de comportamiento.</p>

<p>El patrón tiene una posibilidad muy poderosa: los observadores no necesariamente tienen que estar en el mismo espacio de memoria que la <strong>EntidadConEstados</strong>. Supongan que en vez de que el <strong>SuscriptorDeCambiosDeEstado</strong> tenga el algoritmo que mastica los datos, este envíe estos datos vía una cola a otro sistema para que haga con ellos lo que quiera. De esta manera el patrón nos regala procesamiento asíncrono de peticiones, permitiendo así soportar transacciones de larga duración de manera decente e inteligente con mucho gobierno.</p>

<p>Siendo un poco extremos, podríamos hacer que todos los suscriptores de los eventos se encuentren en distintos espacios de memoria (bien sea en otros servidores virtualizados u otras máquinas virtuales) logrando que todas las consecuencias de un cambio de estado sean procesadas de manera distribuida. Esto es alta disponibilidad y alta capacidad de escalamiento gratis.</p>

<h3 id="restricciones-del-proyecto-ejemplo">Restricciones del proyecto ejemplo</h3>

<p>Debido a que este patrón se me ocurrió para el proyecto de un cliente que tiene su base de código en Java, nuestra implementación fue realizada en ese lenguaje. Sería muy interesante poder tener tiempo de hacer una implementación en un lenguaje como Scala, particularmente por el hecho de estar utilizando el patrón Observador.</p>

<p>También sería interesante hacer una implementación con la librería Guava de Google la cual ofrece una nueva clase <a href="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/eventbus/EventBus.html">EventBus</a> la cual permite suscribirse como escucha (<em>listener</em> en inglés) de eventos y enviar eventos.</p>

<p>Posiblemente un modelo con programación reactiva sea más adecuado para la implementación de los observadores. Para más información de cómo sería el modelo con programación reactiva la pueden encontrar <a href="http://lamp.epfl.ch/~imaier/pub/DeprecatingObserversTR2010.pdf">acá</a>.</p>


    </div>
    <div class="large-4 columns left-border">
        <p class="panel">
          <p class="hide-for-small-only"><span class="subheader">Entradas</span></p>
          <ul class="side-nav no-bullet">
                  
            <li>&#187; <a class="hide-for-small-only" href="/2015/09/01/T%C3%ADtulo%20escandaloso_sobre%20los_desarrolladores_colombianos.html">Título escandaloso sobre los desarrolladores colombianos*</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2014/11/18/futuros_y_actores.html">Futuros y actores en Scala y Akka</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2014/03/09/consistencia.html">Consistencia</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2013/09/21/soa_agil.html">SOA ágil</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2013/05/07/bus_de_eventos_de_dominio.html">Bus de eventos de dominio</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2013/04/13/simpatia_semantica.html">Simpatía semántica</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2013/02/23/pareto_arquitectura_y_scrum.html">Arquitectura, DDD y Scrum.</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2012/04/24/no_bpms.html">No, su proyecto no necesita BPMS</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2011/10/17/patron_estados_observados.html">Patrón de estados observados</a></li>
                  
            <li>&#187; <a class="hide-for-small-only" href="/2011/07/22/soa_no_es_esb.html">SOA != ESB</a></li>
                    
          </ul>
        </p>
        <p class="hide-for-small-only"><span class="subheader">Social </span></p>
          <ul class="side-nav no-bullet">
            <li>» <a class="hide-for-small-only" href="https://bitacora.s3.amazonaws.com/me.html">El autor</a></li>
            <li>» <a class="hide-for-small-only" href="http://twitter.com/ykiriki">@ykiriki</a></li>
            <li>» <a class="hide-for-small-only" href="/atom.xml">Atom 1.0</a></li>
          </ul>
        </p>        
    </div>    
  </div>
  <div class="row">
    <div class="large-12 columns">
      <div id="disqus_thread"></div>bitacora/
        <script type="text/javascript">
          var disqus_shortname = 'bitcora';
          var disqus_identifier = 'http://yujikiriki.com/2011/10/17/patron_estados_observados';
          var disqus_url = 'http://yujikiriki.com/2011/10/17/patron_estados_observados.html';

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>
    </div>
  </div>
<!-- Foundation dependencies -->
    <script src="/js/vendor/jquery.js"></script>
    <script src="/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
    </script>
<!-- Google analytics -->
<!-- 
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24796665-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
   -->    
  </body>
</html>
